2:I[5250,["250","static/chunks/250-7d5fd8d6fcdc95d0.js","328","static/chunks/328-fad5ab9f97aa4619.js","246","static/chunks/app/post/%5Bid%5D/page-4878c8441b494b94.js"],""]
3:I[4357,["250","static/chunks/250-7d5fd8d6fcdc95d0.js","328","static/chunks/328-fad5ab9f97aa4619.js","246","static/chunks/app/post/%5Bid%5D/page-4878c8441b494b94.js"],""]
4:I[3501,["250","static/chunks/250-7d5fd8d6fcdc95d0.js","328","static/chunks/328-fad5ab9f97aa4619.js","246","static/chunks/app/post/%5Bid%5D/page-4878c8441b494b94.js"],"HighlightJS"]
6:I[1142,["250","static/chunks/250-7d5fd8d6fcdc95d0.js","328","static/chunks/328-fad5ab9f97aa4619.js","246","static/chunks/app/post/%5Bid%5D/page-4878c8441b494b94.js"],"Giscus"]
7:I[5613,[],""]
9:I[1778,[],""]
a:I[7388,["185","static/chunks/app/layout-39db1d8929a84f0c.js"],"GoogleTagManager"]
5:T12a0,<h2>目录结构</h2>
<p><a href="https://github.com/facebook/react/tree/main">React</a> 用的是 monorepo 的项目管理方式，在尝试源码阅读时，会发现 packages 中有大量的工具库，不清楚哪些是 react 开发中会用到的。所以首先需要从 react 和 react-dom 这两个已知的入口分析哪些 packages 是实际要用的。</p>
<p>我们可以通过 madge 工具生成 react/index.js 和 react-dom/index.js 的依赖图，得到 react 项目中实际用到的 package</p>
<pre><code class="language-bash">➜  react git:(18.2.0) ✗ madge --json packages/react/index.js packages/react-dom/index.js > deps.json           
➜  react git:(18.2.0) ✗ jq -r 'to_entries[] | .key, (.value[])' deps.json | cut -d '/' -f 1 | sort -u
react
react-dom
react-reconciler
scheduler
shared
➜  react git:(18.2.0) ✗ 
</code></pre>
<p>每个目录的作用大致为：</p>
<pre><code>react: 用于暴露 hooks 和主要 API
react-dom: 包括了 client 和 server 两个部分，主要是用于 Fiber 和 Render 操作
react-reconciler：协调器，用于分配 React 任务，确定权重、优先级等
scheduler：React 所有任务（render、update、event...）调度
shared: 模块公用的方法和全局变量
</code></pre>
<h2>本地 Debug 环境搭建</h2>
<p>React 虽然是 js 项目，但代码中有 type 声明语句，这些声明在编译时通过<code>@babel/plugin-transform-flow-strip-types</code>插件移除。所以如果要 debug 源码，要么使用 react 完整编译产物 + sourcemap 调试，要么 include react 项目并且在构建配置里加入 react 的编译配置。</p>
<p>基于调试成本考虑，使用 react 完整编译产物比较合适。</p>
<p>操作步骤如下：</p>
<ol>
<li>clone react 仓库到本地，monorepo 还是比较大的，浅克隆后切换 head 到目标版本即可，由于我部门用的 react 18.2，所以我主要想看 18.2 的源码</li>
</ol>
<pre><code class="language-bash">git clone https://github.com/facebook/react.git --depth 1

git checkout -b v18.2.0 origin 9e3b772b8cabbd8cadc7522ebe3dde3279e79d9e

# 安装依赖
cd react &#x26;&#x26; yarn
</code></pre>
<ol start="2">
<li>从上面的产物分析中我们知道 React 主要用到的产物，除了 share 作为工具包没有单独的入口，其余 packages 都需要编译</li>
</ol>
<pre><code class="language-bash">yarn build react/index,react/jsx,react-dom/index,scheduler --type=NODE

yarn link

# yarn 会根据 packages 把这两个包注册到全局，可以看到以下输出
yarn link v1.22.22
success Using linked package for "react".
success Using linked package for "react-dom".
Done in 0.02s.
</code></pre>
<ol start="3">
<li>如果想进一步了解每个函数都在源码中的哪个文件下，可以修改构建配置生成 sourcemap</li>
</ol>
<ul>
<li>修改 scripts/rollup/build.js 配置，把 sourcemap 改为 true</li>
<li>修改后会编译失败，因为有部分插件没有 sourcemap，可以根据报错逐个注释。我遇到的有: <code>closure</code> <code>prettier</code> <code>stripUnusedImports</code> <code>renderChunk</code></li>
<li>回到自己要 debug 的 react 应用中，执行<code>yarn link react react-dom</code>把 node_modules 里的 react 和 react-dom 软链到全局目录下。可以通过 <code>ls -l node_modules/react</code> 检查是否连接成功</li>
</ul>
<pre><code class="language-bash">➜  my-app git:(master) ✗ ls -l node_modules/react
lrwxrwxrwx 1 root root 51 May  3 17:59 node_modules/react -> ../../../../usr/local/share/.config/yarn/link/react
</code></pre>
<ul>
<li>配置 React App 的构建项，把 react 和 react-dom external 出去，然后给 react.develement.js 和 react-dom.develement.js 以及对应的 sourcemap 提供对应的静态服务（可以复制到项目下直接复用 dev server，也可以在 react/build/node_modules 目录下 通过 http-server 快速创建）</li>
</ul>
<p>于是我们就可以在控制台文件级别的 debug 了
<img src="/react-debug-0.png" alt="react-debug-0"></p>
<ul>
<li>如果需要进一步在 vscode 中调试，可以编辑 .vscode/launch.json 文件指向 React App 的运行端口</li>
</ul>
<pre><code class="language-json">{
    // Use IntelliSense to learn about possible attributes.
    // Hover to view descriptions of existing attributes.
    // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Launch Chrome",
            "request": "launch",
            "type": "chrome",
            "url": "http://localhost:5173",
            "webRoot": "${workspaceFolder}"
        }
    ]
}
</code></pre>
<p><img src="/react-debug-1.png" alt="react-debug-0"></p>
8:["id","react-debug","d"]
0:["ufuck19qqvtiHZYhvCVmP",[[["",{"children":["post",{"children":[["id","react-debug","d"],{"children":["__PAGE__?{\"id\":\"react-debug\"}",{}]}]}]},"$undefined","$undefined",true],["",{"children":["post",{"children":[["id","react-debug","d"],{"children":["__PAGE__",{},["$L1",["$","div",null,{"className":"min-h-screen flex flex-col bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100","children":[["$","header",null,{"children":["$","nav",null,{"className":"w-[80%] max-w-4xl mx-auto px-4 py-4","children":["$","div",null,{"className":"flex justify-between items-center","children":["$","div",null,{"className":"flex items-center space-x-4","children":[["$","$L2",null,{"href":"/","className":"hover:text-blue-600 dark:hover:text-blue-400","children":"Home"}],["$","$L2",null,{"href":"/posts","className":"hover:text-blue-600 dark:hover:text-blue-400","children":"Posts"}],["$","$L2",null,{"href":"/about","className":"hover:text-blue-600 dark:hover:text-blue-400","children":"About"}],["$","$L3",null,{}]]}]}]}]}],["$","main",null,{"className":"flex-grow w-[80%] max-w-4xl mx-auto px-4 py-8","children":[["$","$L4",null,{}],["$","article",null,{"children":[["$","header",null,{"className":"mb-8","children":[["$","h1",null,{"className":"text-3xl font-bold mb-4","children":"React 本地调试"}],["$","div",null,{"className":"flex flex-wrap gap-2 mb-4","children":["$","div",null,{"className":"flex flex-wrap gap-2 ","children":[["$","$L2",null,{"href":"/posts/React","className":"px-4 py-1 bg-gray-100 dark:bg-gray-800 rounded-lg text-sm hover:bg-gray-200 dark:hover:bg-gray-700 ","children":"React"}]]}]}],["$","div",null,{"className":"flex justify-between text-sm text-gray-500","children":[["$","span",null,{"children":[324," words"]}],["$","span",null,{"children":["Updated: ","May 3, 2025"]}]]}]]}],["$","div",null,{"className":"prose max-w-none","dangerouslySetInnerHTML":{"__html":"$5"}}],["$","section",null,{"className":"mt-12 pt-8 border-t giscus","children":["$","$L6",null,{}]}]]}]]}],["$","footer",null,{"className":"py-8","children":["$","div",null,{"className":"w-[80%] max-w-4xl mx-auto px-4 text-center text-gray-600 dark:text-gray-400","children":["$","p",null,{"children":["© Copyright ",2025]}]}]}]]}],null]]},["$","$L7",null,{"parallelRouterKey":"children","segmentPath":["children","post","children","$8","children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L9",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","styles":[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/6d54c7d60751f978.css","precedence":"next","crossOrigin":""}]]}]]},["$","$L7",null,{"parallelRouterKey":"children","segmentPath":["children","post","children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L9",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","styles":null}]]},[null,["$","html",null,{"lang":"en","children":[["$","body",null,{"className":"antialiased","children":["$","$L7",null,{"parallelRouterKey":"children","segmentPath":["children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L9",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":"404"}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],"notFoundStyles":[],"styles":null}]}],["$","$La",null,{"gtmId":"G-7Q3TCZRD8L"}]]}],null]],[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/d31599b71916805b.css","precedence":"next","crossOrigin":""}]],"$Lb"]]]]
b:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","meta","1",{"charSet":"utf-8"}],["$","title","2",{"children":"Osyo's Blog"}],["$","meta","3",{"name":"description","content":"A personal blog built with Next.js"}],["$","link","4",{"rel":"icon","href":"/favicon.ico","type":"image/x-icon","sizes":"16x16"}]]
1:null
